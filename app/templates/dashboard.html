{% extends "base.html" %}

{% block content %}
<div class="pt-3 pb-32">
  <!-- Header -->
  <header class="dashboard-header mb-3 flex items-center justify-between max-w-screen-xl mx-auto px-2">
    <div>
      <h1 class="text-2xl font-medium tracking-tight">Dashboard</h1>
      <p class="text-sm mt-1" style="color: var(--kb-text-muted);">Personal assistant</p>
    </div>
    
    <div class="flex items-center gap-2">
      <!-- Add Panel Button -->
      <button 
        onclick="window.openMarketModal()"
        class="p-2 rounded-lg transition-colors"
        style="border: 1px solid var(--kb-border); color: var(--kb-text-dim);"
        onmouseover="this.style.backgroundColor='var(--kb-bg-hover)'"
        onmouseout="this.style.backgroundColor='transparent'"
        title="Add Panel"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
        </svg>
      </button>
      
      <!-- Tasks Button -->
      <button 
        onclick="window.openTasksModal()"
        class="p-2 rounded-lg transition-colors"
        style="border: 1px solid var(--kb-border); color: var(--kb-text-dim);"
        onmouseover="this.style.backgroundColor='var(--kb-bg-hover)'"
        onmouseout="this.style.backgroundColor='transparent'"
        title="Scheduled Tasks"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
      
      <!-- Theme Toggle -->
      <button 
        onclick="toggleTheme()"
        class="p-2 rounded-lg transition-colors"
        style="border: 1px solid var(--kb-border); color: var(--kb-text-dim);"
        onmouseover="this.style.backgroundColor='var(--kb-bg-hover)'"
        onmouseout="this.style.backgroundColor='transparent'"
        title="Toggle theme"
      >
        <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Dashboard Panels Grid -->
  <div id="dashboard-panels"
       class="grid-stack"
       hx-get="/dashboard-panels"
       hx-trigger="refresh from:body">
    {% for panel in panels %}
      {% include "partials/panel.html" %}
    {% else %}
      <div class="w-full text-center py-16" style="color: var(--kb-text-faint); grid-column: span 12;">
        <p class="text-sm">No panels yet</p>
        <p class="text-xs mt-2" style="color: var(--kb-text-ghost);">Chat with the assistant to get started</p>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Tasks Modal -->
<div id="tasks-modal" 
     x-data="tasksModal" 
     x-show="open" 
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center"
     @keydown.escape.window="open = false">
  <!-- Backdrop -->
  <div class="modal-overlay absolute inset-0" @click="open = false"></div>
  
  <!-- Modal -->
  <div class="modal-content relative rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4" style="border-bottom: 1px solid var(--kb-border);">
      <h2 class="text-lg font-medium" style="color: var(--kb-text-primary);">Scheduled Tasks</h2>
      <button @click="open = false" class="p-1 rounded" style="color: var(--kb-text-dim);">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- Content -->
    <div class="px-6 py-4 overflow-y-auto max-h-[60vh]">
      <div x-show="loading" class="text-center py-8" style="color: var(--kb-text-dim);">Loading...</div>
      
      <div x-show="!loading && tasks.length === 0" class="text-center py-8" style="color: var(--kb-text-dim);">No scheduled tasks</div>
      
      <div x-show="!loading && tasks.length > 0" class="space-y-3">
        <template x-for="task in tasks" :key="task.id">
          <div class="p-4 rounded-lg" style="border: 1px solid var(--kb-border);">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-medium" style="color: var(--kb-text-primary);" x-text="task.name"></span>
                  <span class="px-1.5 py-0.5 text-xs rounded" style="background: var(--kb-bg-tertiary); color: var(--kb-text-muted);" x-text="task.type"></span>
                  <span x-show="!task.enabled" class="px-1.5 py-0.5 text-xs rounded" style="background: var(--kb-bg-hover); color: var(--kb-text-dim);">disabled</span>
                </div>
                <div class="text-sm mt-1" style="color: var(--kb-text-muted);">
                  <span class="font-mono" x-text="task.schedule"></span>
                </div>
                <!-- Last Run -->
                <div x-show="task.lastRun" class="mt-2 text-xs">
                  <span :style="task.lastRun?.success ? 'color: var(--kb-text-muted);' : 'color: var(--kb-red);'">
                    Last run: <span x-text="task.lastRun ? formatTime(task.lastRun.endTime) : ''"></span>
                    (<span x-text="task.lastRun ? task.lastRun.durationMs + 'ms' : ''"></span>)
                    <span x-show="task.lastRun && !task.lastRun.success" style="color: var(--kb-red);">- Failed</span>
                  </span>
                </div>
                <div x-show="!task.lastRun" class="mt-2 text-xs" style="color: var(--kb-text-faint);">Never run</div>
              </div>
              
              <!-- Run Button -->
              <button 
                @click="runTask(task.id)"
                :disabled="runningTask === task.id"
                class="px-3 py-1.5 text-sm rounded-lg disabled:opacity-50"
                style="border: 1px solid var(--kb-border); color: var(--kb-text-muted);"
              >
                <span x-show="runningTask !== task.id">Run Now</span>
                <span x-show="runningTask === task.id">Running...</span>
              </button>
            </div>
            
            <!-- Result -->
            <div x-show="taskResults[task.id]" class="mt-3 p-2 rounded text-xs font-mono" style="background: var(--kb-bg-tertiary);">
              <div x-show="taskResults[task.id]?.success" style="color: var(--kb-text-muted);" x-text="taskResults[task.id]?.output"></div>
              <div x-show="taskResults[task.id] && !taskResults[task.id]?.success" style="color: var(--kb-red);" x-text="taskResults[task.id]?.error"></div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
</div>

<!-- Market Modal -->
<div id="market-modal" 
     x-data="marketModal" 
     x-show="open" 
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center"
     @keydown.escape.window="open = false">
  <!-- Backdrop -->
  <div class="modal-overlay absolute inset-0" @click="open = false"></div>
  
  <!-- Modal -->
  <div class="modal-content relative rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4" style="border-bottom: 1px solid var(--kb-border);">
      <h2 class="text-lg font-medium" style="color: var(--kb-text-primary);">Add Panel</h2>
      <button @click="open = false" class="p-1 rounded" style="color: var(--kb-text-dim);">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- Content -->
    <div class="px-6 py-4 overflow-y-auto max-h-[60vh]">
      <div x-show="loading" class="text-center py-8" style="color: var(--kb-text-dim);">Loading...</div>
      
      <!-- Panel Grid - click to install directly -->
      <div x-show="!loading" class="grid grid-cols-2 gap-3">
        <template x-for="panel in panels" :key="panel.id">
          <button 
            @click="installDirect(panel)"
            :disabled="installing === panel.id"
            class="p-4 rounded-lg text-left transition-colors disabled:opacity-50"
            style="border: 1px solid var(--kb-border);"
            onmouseover="this.style.backgroundColor='var(--kb-bg-hover)'"
            onmouseout="this.style.backgroundColor='transparent'"
          >
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl" 
                   :style="'background: var(--kb-' + panel.headerColor + ');'">
                <span x-text="getEmoji(panel.icon)"></span>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium" style="color: var(--kb-text-primary);" x-text="panel.name"></div>
                <div class="text-xs truncate" style="color: var(--kb-text-muted);" x-text="panel.description"></div>
              </div>
              <div x-show="installing === panel.id" class="ml-2">
                <svg class="w-4 h-4 animate-spin" style="color: var(--kb-text-muted);" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
            </div>
          </button>
        </template>
      </div>
      
      <!-- Error -->
      <div x-show="error" class="mt-3 text-sm text-center" style="color: var(--kb-red);" x-text="error"></div>
    </div>
  </div>
</div>

<script>
// Dot grid mouse glow â€” track mouse across full page
document.addEventListener('mousemove', (e) => {
  document.body.style.setProperty('--mouse-x', e.clientX + 'px');
  document.body.style.setProperty('--mouse-y', e.clientY + 'px');
});

function toggleTheme() {
  const html = document.documentElement;
  if (html.classList.contains('dark')) {
    html.classList.remove('dark');
    localStorage.theme = 'light';
  } else {
    html.classList.add('dark');
    localStorage.theme = 'dark';
  }
}

window.openTasksModal = function() {
  const el = document.getElementById('tasks-modal');
  if (el && el._x_dataStack) {
    const data = el._x_dataStack[0];
    data.open = true;
    data.loadTasks();
  }
};

window.openMarketModal = function() {
  const el = document.getElementById('market-modal');
  if (el && el._x_dataStack) {
    const data = el._x_dataStack[0];
    data.open = true;
    data.loadPanels();
  }
};

// Icon to emoji mapping
const iconEmojis = {
  'check-square': 'âœ…',
  'cloud': 'ðŸŒ¤ï¸',
  'globe': 'ðŸŒ',
  'play': 'â–¶ï¸',
  'image': 'ðŸ–¼ï¸',
  'calendar': 'ðŸ“…',
  'clock': 'â°',
  'default': 'ðŸ“¦'
};

// Global panelAction function for template handlers
async function panelAction(panelId, action, payload = {}) {
  try {
    const target = document.querySelector(`#panel-${panelId} .card-content`);
    if (!target) return;
    // POST body as JSON, HTMX swaps the returned HTML into .card-content
    const res = await fetch(`/api/panels/${panelId}/action`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, payload })
    });
    if (res.ok) {
      target.innerHTML = await res.text();
    }
  } catch (e) {
    console.error(`Panel action failed: ${panelId}/${action}`, e);
  }
}
window.panelAction = panelAction;

// Tasks Modal Alpine component
document.addEventListener('alpine:init', () => {
  Alpine.data('tasksModal', () => ({
    open: false,
    loading: false,
    tasks: [],
    runningTask: null,
    taskResults: {},
    
    async loadTasks() {
      this.loading = true;
      try {
        const res = await fetch('/api/tasks');
        this.tasks = await res.json();
      } catch (e) {
        console.error('Failed to load tasks:', e);
      } finally {
        this.loading = false;
      }
    },
    
    async runTask(taskId) {
      this.runningTask = taskId;
      delete this.taskResults[taskId];
      try {
        const res = await fetch(`/api/tasks/${taskId}/run`, { method: 'POST' });
        const result = await res.json();
        this.taskResults[taskId] = result;
        // Update lastRun in task
        const task = this.tasks.find(t => t.id === taskId);
        if (task) task.lastRun = result;
        // Refresh dashboard if needed
        if (result.success) {
          htmx.ajax('GET', '/dashboard-panels', { target: '#dashboard-panels', swap: 'innerHTML' });
        }
      } catch (e) {
        this.taskResults[taskId] = { success: false, error: e.message };
      } finally {
        this.runningTask = null;
      }
    },
    
    formatTime(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      return d.toLocaleString();
    }
  }));
  
  Alpine.data('marketModal', () => ({
    open: false,
    loading: false,
    panels: [],
    installing: null,
    error: null,
    
    async loadPanels() {
      this.loading = true;
      this.error = null;
      try {
        const res = await fetch('/api/market');
        this.panels = await res.json();
      } catch (e) {
        console.error('Failed to load market:', e);
      } finally {
        this.loading = false;
      }
    },
    
    getEmoji(icon) {
      return iconEmojis[icon] || iconEmojis.default;
    },
    
    async installDirect(panel) {
      this.installing = panel.id;
      this.error = null;
      try {
        const res = await fetch(`/api/market/${panel.id}/install`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const result = await res.json();
        if (result.success) {
          this.open = false;
          // Refresh dashboard
          htmx.ajax('GET', '/dashboard-panels', { target: '#dashboard-panels', swap: 'innerHTML' });
        } else {
          this.error = result.error || 'Failed to install panel';
        }
      } catch (e) {
        this.error = e.message;
      } finally {
        this.installing = null;
      }
    }
  }));
});
</script>

<!-- Chat Box -->
{% include "components/chat_box.html" %}
{% endblock %}
