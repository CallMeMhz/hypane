{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-8 pb-24">
  <!-- Header -->
  <header class="mb-10 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-medium text-gray-800 dark:text-gray-100 tracking-tight">Dashboard</h1>
      <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Personal assistant</p>
    </div>
    
    <div class="flex items-center gap-2">
      <!-- Tasks Button -->
      <button 
        onclick="window.openTasksModal()"
        class="p-2 rounded-lg border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800/50 transition-colors"
        title="Scheduled Tasks"
      >
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
      
      <!-- Theme Toggle -->
      <button 
        onclick="toggleTheme()"
        class="p-2 rounded-lg border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800/50 transition-colors"
        title="Toggle theme"
      >
        <svg class="w-5 h-5 text-gray-400 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg class="w-5 h-5 text-gray-400 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Dashboard Cards Grid -->
  <div id="dashboard-cards" 
       class="dashboard-grid"
       hx-get="/dashboard-cards" 
       hx-trigger="refresh from:body">
    <div class="card-sizer"></div>
    {% for card in cards %}
      {% include "partials/card.html" %}
    {% else %}
      <div class="w-full text-center text-gray-500 dark:text-gray-400 py-16">
        <p class="text-sm">No cards yet</p>
        <p class="text-xs mt-2 text-gray-400 dark:text-gray-500">Chat with the assistant to get started</p>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Tasks Modal -->
<div id="tasks-modal" 
     x-data="tasksModal" 
     x-show="open" 
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center"
     @keydown.escape.window="open = false">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50" @click="open = false"></div>
  
  <!-- Modal -->
  <div class="relative bg-white dark:bg-gray-900 rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden border border-gray-200 dark:border-gray-800">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-800">
      <h2 class="text-lg font-medium text-gray-800 dark:text-gray-100">Scheduled Tasks</h2>
      <button @click="open = false" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- Content -->
    <div class="px-6 py-4 overflow-y-auto max-h-[60vh]">
      <div x-show="loading" class="text-center py-8 text-gray-400">Loading...</div>
      
      <div x-show="!loading && tasks.length === 0" class="text-center py-8 text-gray-400">No scheduled tasks</div>
      
      <div x-show="!loading && tasks.length > 0" class="space-y-3">
        <template x-for="task in tasks" :key="task.id">
          <div class="p-4 rounded-lg border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-700">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-gray-800 dark:text-gray-200" x-text="task.name"></span>
                  <span class="px-1.5 py-0.5 text-xs rounded bg-gray-100 dark:bg-gray-800 text-gray-500" x-text="task.type"></span>
                  <span x-show="!task.enabled" class="px-1.5 py-0.5 text-xs rounded bg-gray-200 dark:bg-gray-700 text-gray-500">disabled</span>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                  <span class="font-mono" x-text="task.schedule"></span>
                </div>
                <!-- Last Run -->
                <div x-show="task.lastRun" class="mt-2 text-xs">
                  <span :class="task.lastRun?.success ? 'text-gray-500' : 'text-red-400'">
                    Last run: <span x-text="task.lastRun ? formatTime(task.lastRun.endTime) : ''"></span>
                    (<span x-text="task.lastRun ? task.lastRun.durationMs + 'ms' : ''"></span>)
                    <span x-show="task.lastRun && !task.lastRun.success" class="text-red-400">- Failed</span>
                  </span>
                </div>
                <div x-show="!task.lastRun" class="mt-2 text-xs text-gray-500">Never run</div>
              </div>
              
              <!-- Run Button -->
              <button 
                @click="runTask(task.id)"
                :disabled="runningTask === task.id"
                class="px-3 py-1.5 text-sm rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 disabled:opacity-50"
              >
                <span x-show="runningTask !== task.id">Run Now</span>
                <span x-show="runningTask === task.id">Running...</span>
              </button>
            </div>
            
            <!-- Result -->
            <div x-show="taskResults[task.id]" class="mt-3 p-2 rounded bg-gray-50 dark:bg-gray-800 text-xs font-mono">
              <div x-show="taskResults[task.id]?.success" class="text-gray-600 dark:text-gray-400" x-text="taskResults[task.id]?.output"></div>
              <div x-show="taskResults[task.id] && !taskResults[task.id]?.success" class="text-red-400" x-text="taskResults[task.id]?.error"></div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
</div>

<script>
function toggleTheme() {
  const html = document.documentElement;
  if (html.classList.contains('dark')) {
    html.classList.remove('dark');
    localStorage.theme = 'light';
  } else {
    html.classList.add('dark');
    localStorage.theme = 'dark';
  }
}

window.openTasksModal = function() {
  const el = document.getElementById('tasks-modal');
  if (el && el._x_dataStack) {
    const data = el._x_dataStack[0];
    data.open = true;
    data.loadTasks();
  }
};

// Tasks Modal Alpine component
document.addEventListener('alpine:init', () => {
  Alpine.data('tasksModal', () => ({
    open: false,
    loading: false,
    tasks: [],
    runningTask: null,
    taskResults: {},
    
    async loadTasks() {
      this.loading = true;
      try {
        const res = await fetch('/api/tasks');
        this.tasks = await res.json();
      } catch (e) {
        console.error('Failed to load tasks:', e);
      } finally {
        this.loading = false;
      }
    },
    
    async runTask(taskId) {
      this.runningTask = taskId;
      delete this.taskResults[taskId];
      try {
        const res = await fetch(`/api/tasks/${taskId}/run`, { method: 'POST' });
        const result = await res.json();
        this.taskResults[taskId] = result;
        // Update lastRun in task
        const task = this.tasks.find(t => t.id === taskId);
        if (task) task.lastRun = result;
        // Refresh dashboard if needed
        if (result.success) {
          htmx.ajax('GET', '/dashboard-cards', { target: '#dashboard-cards', swap: 'innerHTML' });
        }
      } catch (e) {
        this.taskResults[taskId] = { success: false, error: e.message };
      } finally {
        this.runningTask = null;
      }
    },
    
    formatTime(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      return d.toLocaleString();
    }
  }));
});
</script>

<!-- Chat Box -->
{% include "components/chat_box.html" %}
{% endblock %}
