{% extends "base.html" %}

{% block title %}Resource Console{% endblock %}

{% block content %}
<div class="h-screen flex flex-col" x-data="consoleApp">
  <!-- Header -->
  <header class="px-4 py-3 flex items-center gap-4 flex-shrink-0" style="background: var(--kb-bg-tertiary); border-bottom: 1px solid var(--kb-border);">
    <a href="/" class="p-1.5 rounded-lg transition-colors" style="color: var(--kb-text-dim);"
       onmouseover="this.style.backgroundColor='var(--kb-bg-hover)'"
       onmouseout="this.style.backgroundColor='transparent'">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7" />
      </svg>
    </a>
    <h1 class="text-lg font-medium" style="color: var(--kb-text-primary);">Resource Console</h1>

    <div class="ml-auto flex items-center gap-3">
      <!-- Legend -->
      <div class="flex items-center gap-3 text-xs" style="color: var(--kb-text-dim);">
        <span class="flex items-center gap-1"><span class="inline-block w-2.5 h-2.5 rounded" style="background: var(--kb-blue);"></span> Panel</span>
        <span class="flex items-center gap-1"><span class="inline-block w-2.5 h-2.5 rounded" style="background: var(--kb-yellow);"></span> Storage</span>
        <span class="flex items-center gap-1"><span class="inline-block w-2.5 h-2.5 rounded" style="background: var(--kb-green);"></span> Task</span>
      </div>

      <!-- Theme Toggle -->
      <button
        onclick="toggleTheme()"
        class="p-2 rounded-lg transition-colors"
        style="border: 1px solid var(--kb-border); color: var(--kb-text-dim);"
        onmouseover="this.style.backgroundColor='var(--kb-bg-hover)'"
        onmouseout="this.style.backgroundColor='transparent'"
        title="Toggle theme"
      >
        <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Three-column grid -->
  <div class="flex-1 min-h-0 grid grid-cols-3 gap-4 p-4">

    <!-- PANELS column -->
    <div class="flex flex-col min-h-0">
      <h2 class="text-sm font-semibold uppercase tracking-wider mb-3 flex-shrink-0 flex items-center" style="color: var(--kb-text-muted);">
        Panels <span class="font-normal" x-text="'(' + panels.length + ')'"></span>
        <span x-show="selectedType && selectedType !== 'panel'" class="ml-auto text-xs font-normal px-1.5 py-0.5 rounded"
              style="background: color-mix(in srgb, var(--kb-blue) 20%, transparent); color: var(--kb-blue);"
              x-text="matchedPanelCount + ' matched'"></span>
      </h2>
      <div x-ref="panelsList" class="flex-1 overflow-y-auto space-y-2">
        <div x-show="panels.length === 0" class="text-sm py-4" style="color: var(--kb-text-faint);">No panels</div>
        <template x-for="p in panels" :key="p.id">
          <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer transition-opacity"
               :data-matched="isPanelMatched(p)"
               style="border: 1px solid var(--kb-border);"
               :style="{
                 borderColor: selectedType === 'panel' && selectedId === p.id ? 'var(--kb-blue)' : '',
                 opacity: selectedType && !isPanelMatched(p) ? 0.3 : 1
               }"
               @click="select('panel', p.id)">
            <span class="w-1 h-8 rounded-full flex-shrink-0" style="background: var(--kb-blue);"></span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-medium text-sm" style="color: var(--kb-text-primary);" x-text="(p.icon || '') + ' ' + p.title"></span>
                <span class="text-xs px-1.5 py-0.5 rounded" style="background: var(--kb-bg-tertiary); color: var(--kb-text-muted);" x-text="p.size"></span>
              </div>
              <div class="text-xs mt-0.5 font-mono truncate" style="color: var(--kb-text-faint);" x-text="p.id"></div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- STORAGES column -->
    <div class="flex flex-col min-h-0">
      <h2 class="text-sm font-semibold uppercase tracking-wider mb-3 flex-shrink-0 flex items-center" style="color: var(--kb-text-muted);">
        Storages <span class="font-normal" x-text="'(' + storages.length + ')'"></span>
        <template x-if="!selectedType || selectedType === 'storage'">
          <span x-show="orphanIds.length" class="ml-2 text-xs font-normal px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--kb-yellow) 20%, transparent); color: var(--kb-yellow);">
            orphans: <span x-text="orphanIds.length"></span>
          </span>
        </template>
        <span x-show="selectedType && selectedType !== 'storage'" class="ml-auto text-xs font-normal px-1.5 py-0.5 rounded"
              style="background: color-mix(in srgb, var(--kb-yellow) 20%, transparent); color: var(--kb-yellow);"
              x-text="matchedStorageCount + ' matched'"></span>
      </h2>
      <div x-ref="storagesList" class="flex-1 overflow-y-auto space-y-2">
        <div x-show="storages.length === 0" class="text-sm py-4" style="color: var(--kb-text-faint);">No storages</div>
        <template x-for="s in storages" :key="s.id">
          <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer transition-opacity"
               :data-matched="isStorageMatched(s)"
               style="border: 1px solid var(--kb-border);"
               :style="{
                 borderColor: selectedType === 'storage' && selectedId === s.id
                   ? 'var(--kb-yellow)'
                   : orphanIds.includes(s.id) ? 'var(--kb-yellow)' : '',
                 opacity: selectedType && !isStorageMatched(s) ? 0.3 : 1
               }"
               @click="select('storage', s.id)">
            <span class="w-1 h-8 rounded-full flex-shrink-0" style="background: var(--kb-yellow);"></span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-medium text-sm font-mono" style="color: var(--kb-text-primary);" x-text="s.id"></span>
                <span x-show="orphanIds.includes(s.id)" class="text-xs px-1.5 py-0.5 rounded" style="background: color-mix(in srgb, var(--kb-yellow) 20%, transparent); color: var(--kb-yellow);">
                  unused
                </span>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- TASKS column -->
    <div class="flex flex-col min-h-0">
      <h2 class="text-sm font-semibold uppercase tracking-wider mb-3 flex-shrink-0 flex items-center" style="color: var(--kb-text-muted);">
        Tasks <span class="font-normal" x-text="'(' + tasks.length + ')'"></span>
        <span x-show="selectedType && selectedType !== 'task'" class="ml-auto text-xs font-normal px-1.5 py-0.5 rounded"
              style="background: color-mix(in srgb, var(--kb-green) 20%, transparent); color: var(--kb-green);"
              x-text="matchedTaskCount + ' matched'"></span>
      </h2>
      <div x-ref="tasksList" class="flex-1 overflow-y-auto space-y-2">
        <div x-show="tasks.length === 0" class="text-sm py-4" style="color: var(--kb-text-faint);">No tasks</div>
        <template x-for="t in tasks" :key="t.id">
          <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer transition-opacity"
               :data-matched="isTaskMatched(t)"
               style="border: 1px solid var(--kb-border);"
               :style="{
                 borderColor: selectedType === 'task' && selectedId === t.id ? 'var(--kb-green)' : '',
                 opacity: selectedType && !isTaskMatched(t) ? 0.3 : 1
               }"
               @click="select('task', t.id)">
            <span class="w-1 h-8 rounded-full flex-shrink-0" style="background: var(--kb-green);"></span>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-medium text-sm" style="color: var(--kb-text-primary);" x-text="t.name"></span>
                <span x-show="t.schedule" class="text-xs font-mono px-1.5 py-0.5 rounded" style="background: var(--kb-bg-tertiary); color: var(--kb-text-muted);" x-text="t.schedule"></span>
                <span x-show="!t.enabled" class="text-xs px-1.5 py-0.5 rounded" style="background: var(--kb-bg-hover); color: var(--kb-text-dim);">disabled</span>
              </div>
              <div class="text-xs mt-0.5 font-mono truncate" style="color: var(--kb-text-faint);" x-text="t.id"></div>
            </div>
          </div>
        </template>
      </div>
    </div>

  </div>
</div>

<script>
  window.__CONSOLE_DATA__ = {
    panels: {{ panels | tojson }},
    storages: {{ storages | tojson }},
    tasks: {{ tasks | tojson }},
    storageRefs: {{ storage_refs | tojson }},
    orphanIds: {{ orphan_ids | tojson }},
  }

  function toggleTheme() {
    const html = document.documentElement;
    if (html.classList.contains('dark')) {
      html.classList.remove('dark');
      localStorage.theme = 'light';
    } else {
      html.classList.add('dark');
      localStorage.theme = 'dark';
    }
  }

  document.addEventListener('alpine:init', () => {
    Alpine.data('consoleApp', () => ({
      panels: window.__CONSOLE_DATA__.panels,
      storages: window.__CONSOLE_DATA__.storages,
      tasks: window.__CONSOLE_DATA__.tasks,
      storageRefs: window.__CONSOLE_DATA__.storageRefs,
      orphanIds: window.__CONSOLE_DATA__.orphanIds,

      selectedType: null,
      selectedId: null,

      select(type, id) {
        if (this.selectedType === type && this.selectedId === id) {
          this.selectedType = null;
          this.selectedId = null;
        } else {
          this.selectedType = type;
          this.selectedId = id;
          this.$nextTick(() => this._scrollToFirstMatched());
        }
      },

      _scrollToFirstMatched() {
        for (const ref of [this.$refs.panelsList, this.$refs.storagesList, this.$refs.tasksList]) {
          const first = ref.querySelector('[data-matched="true"]');
          if (first) {
            const containerTop = ref.getBoundingClientRect().top;
            const itemTop = first.getBoundingClientRect().top;
            if (itemTop < containerTop || itemTop > containerTop + ref.clientHeight) {
              first.scrollIntoView({ block: 'start', behavior: 'smooth' });
            }
          }
        }
      },

      _getStorageIds(type, id) {
        if (type === 'panel') {
          const p = this.panels.find(p => p.id === id);
          return p?.storage_ids || [];
        }
        if (type === 'storage') return [id];
        if (type === 'task') {
          const t = this.tasks.find(t => t.id === id);
          return t?.storage_ids || [];
        }
        return [];
      },

      isPanelMatched(p) {
        if (!this.selectedType) return true;
        if (this.selectedType === 'panel') return p.id === this.selectedId;
        const selSids = this._getStorageIds(this.selectedType, this.selectedId);
        const pSids = p.storage_ids || [];
        return pSids.some(sid => selSids.includes(sid));
      },

      isStorageMatched(s) {
        if (!this.selectedType) return true;
        if (this.selectedType === 'storage') return s.id === this.selectedId;
        const selSids = this._getStorageIds(this.selectedType, this.selectedId);
        return selSids.includes(s.id);
      },

      isTaskMatched(t) {
        if (!this.selectedType) return true;
        if (this.selectedType === 'task') return t.id === this.selectedId;
        const selSids = this._getStorageIds(this.selectedType, this.selectedId);
        const tSids = t.storage_ids || [];
        if (this.selectedType === 'panel') {
          return tSids.length > 0 && tSids.every(sid => selSids.includes(sid));
        }
        return tSids.some(sid => selSids.includes(sid));
      },

      get matchedPanelCount() {
        if (!this.selectedType) return 0;
        return this.panels.filter(p => this.isPanelMatched(p)).length;
      },

      get matchedStorageCount() {
        if (!this.selectedType) return 0;
        return this.storages.filter(s => this.isStorageMatched(s)).length;
      },

      get matchedTaskCount() {
        if (!this.selectedType) return 0;
        return this.tasks.filter(t => this.isTaskMatched(t)).length;
      },

      async deleteStorage(storageId) {
        if (!confirm(`Delete orphan storage "${storageId}"?`)) return;
        try {
          const res = await fetch(`/api/storages/${storageId}`, { method: 'DELETE' });
          if (res.ok) {
            this.storages = this.storages.filter(s => s.id !== storageId);
            this.orphanIds = this.orphanIds.filter(id => id !== storageId);
          }
        } catch (e) {
          console.error('Failed to delete storage:', e);
        }
      },
    }));
  });
</script>
{% endblock %}
