<div 
  x-data="todoList()" 
  x-init="init()" 
  style="display: flex; flex-direction: column; height: 100%;"
>
  <!-- 列表区域 -->
  <div style="flex: 1; overflow-y: auto; min-height: 0;">
    <ul class="space-y-2">
      <template x-for="item in items" :key="item.id">
        <li class="flex items-center gap-2 text-sm group">
          <button @click="toggle(item.id)" 
                  class="w-4 h-4 flex-shrink-0 flex items-center justify-center rounded border transition-colors"
                  :class="item.done ? 'border-gray-600 bg-gray-700' : 'border-gray-600 hover:border-gray-500'">
            <span x-show="item.done" class="text-xs text-gray-400">✓</span>
          </button>
          <span class="flex-1" :class="item.done ? 'line-through text-gray-600' : 'text-gray-300'" x-text="item.text"></span>
          <button @click="remove(item.id)" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400 p-0.5 flex-shrink-0">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </li>
      </template>
    </ul>
    <p x-show="items.length === 0" class="text-gray-600 text-center py-4 text-sm">No items</p>
  </div>
  
  <!-- Input 区域 -->
  <form @submit.prevent="add()" style="flex-shrink: 0;" class="flex gap-2 pt-2 mt-2 border-t border-gray-800">
    <input type="text" x-model="newText" placeholder="Add item..."
           class="flex-1 text-sm px-2 py-1.5 rounded border border-gray-700 bg-gray-900 text-gray-300 placeholder-gray-600 focus:outline-none focus:border-gray-500">
    <button type="submit" :disabled="!newText.trim()"
            class="text-xs px-3 py-1.5 rounded bg-gray-800 text-gray-400 hover:bg-gray-700 disabled:opacity-50">Add</button>
  </form>
</div>
<script>
if (!window.todoList) {
  window.todoList = function() {
    return {
      items: [],
      newText: '',
      panelId: '',
      async init() {
        // Get panel ID from parent .card-content element
        const content = this.$el.closest('.card-content');
        this.panelId = content ? content.dataset.panelId : null;
        if (!this.panelId) {
          console.error('todoList: cannot find panel ID');
          return;
        }
        try {
          const res = await fetch('/api/panels/' + this.panelId + '/data');
          if (res.ok) {
            const data = await res.json();
            this.items = data.items || [];
          }
        } catch (e) {
          console.error('Failed to load items:', e);
        }
      },
      async save() {
        if (!this.panelId) return;
        await fetch('/api/panels/' + this.panelId + '/data', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: this.items })
        });
      },
      toggle(id) {
        const item = this.items.find(i => i.id === id);
        if (item) { item.done = !item.done; this.save(); }
      },
      remove(id) {
        this.items = this.items.filter(i => i.id !== id);
        this.save();
      },
      add() {
        if (!this.newText.trim()) return;
        this.items.push({ id: Date.now().toString(16), text: this.newText.trim(), done: false });
        this.newText = '';
        this.save();
      }
    };
  };
}
</script>
