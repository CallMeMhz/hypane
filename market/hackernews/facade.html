{% set data = storage.get('hackernews', {}) %}
{% set stories = data.get('stories', []) %}
{% set updated = data.get('updated_at', '') %}

<div x-data="{ expanded: null }" class="flex flex-col h-full text-sm">
  <!-- Story list -->
  <div class="flex-1 overflow-y-auto space-y-1 pr-1">
    {% for story in stories %}
    <div class="group rounded-lg px-2 py-1.5 hover:bg-gray-500/10 transition-colors">
      <!-- Title row -->
      <div class="flex items-start gap-2">
        <span class="text-xs font-mono shrink-0 mt-0.5" style="color: var(--kb-orange)">{{ loop.index }}</span>
        <div class="min-w-0 flex-1">
          <a href="{{ story.url or story.hn_url }}" target="_blank" rel="noopener"
             class="text-gray-200 hover:text-white leading-tight block truncate-2">
            {{ story.title }}
          </a>
          {% if story.domain %}
          <span class="text-xs text-gray-500">({{ story.domain }})</span>
          {% endif %}
        </div>
      </div>

      <!-- Meta row -->
      <div class="flex items-center gap-3 mt-1 ml-5 text-xs text-gray-500">
        <span style="color: var(--kb-orange)">{{ story.score }} pts</span>
        <span>by {{ story.by }}</span>
        <a href="{{ story.hn_url }}" target="_blank" rel="noopener"
           class="hover:underline" style="color: var(--kb-yellow)">
          {{ story.comments_count }} comments
        </a>
        <span>{{ story.time_ago }}</span>
      </div>

      <!-- Top comment (expandable) -->
      {% if story.top_comment %}
      <div class="ml-5 mt-1">
        <button @click="expanded === {{ loop.index0 }} ? expanded = null : expanded = {{ loop.index0 }}"
                class="text-xs text-gray-500 hover:text-gray-300 transition-colors flex items-center gap-1">
          <svg class="w-3 h-3 transition-transform" :class="expanded === {{ loop.index0 }} && 'rotate-90'"
               fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
          </svg>
          top comment by {{ story.top_comment.by }}
        </button>
        <div x-show="expanded === {{ loop.index0 }}" x-collapse
             class="text-xs text-gray-400 mt-1 pl-3 leading-relaxed"
             style="border-left: 2px solid var(--kb-orange)">
          {{ story.top_comment.text }}
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}

    {% if not stories %}
    <div class="flex items-center justify-center h-full text-gray-500 text-sm">
      Loading stories...
    </div>
    {% endif %}
  </div>

  <!-- Footer -->
  {% if updated %}
  <div class="text-xs text-gray-600 text-right pt-1 shrink-0 border-t" style="border-color: var(--kb-border)">
    Updated {{ updated[:16].replace('T', ' ') }} UTC
  </div>
  {% endif %}
</div>

<style>
  .truncate-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
